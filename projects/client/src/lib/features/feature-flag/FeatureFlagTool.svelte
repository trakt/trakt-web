<script lang="ts">
  import ActionButton from "$lib/components/buttons/ActionButton.svelte";
  import Drawer from "$lib/components/drawer/Drawer.svelte";
  import CircularLogo from "$lib/components/icons/CircularLogo.svelte";
  import Switch from "$lib/components/toggles/Switch.svelte";
  import RenderFor from "$lib/guards/RenderFor.svelte";
  import { safeLocalStorage } from "$lib/utils/storage/safeStorage.ts";
  import { writable } from "svelte/store";
  import { FEATURE_FLAG_LOCAL_STORAGE_KEY } from "./_internal/createFeatureFlagContext.ts";
  import { getFeatureFlagContext } from "./_internal/getFeatureFlagContext.ts";
  import { FeatureFlag } from "./models/FeatureFlag.ts";

  const { flags } = getFeatureFlagContext();

  const setFlag = (flag: FeatureFlag, value: boolean) => {
    flags.update((currentFlags) => {
      const updatedFlags = { ...currentFlags, [flag]: value };
      safeLocalStorage.setItem(
        FEATURE_FLAG_LOCAL_STORAGE_KEY,
        JSON.stringify(updatedFlags),
      );
      return updatedFlags;
    });
  };

  const isOpen = writable(false);
  const onClose = () => isOpen.set(false);

  const hasFlags = $derived(Object.keys($flags).length > 0);
</script>

<RenderFor audience="director">
  <ActionButton
    label="Feature flags"
    onclick={() => isOpen.set(!$isOpen)}
    style="ghost"
  >
    <CircularLogo variant="flat" />
  </ActionButton>

  {#if $isOpen}
    <Drawer {onClose} title="Feature Flags" hasAutoClose={false}>
      {#if hasFlags}
        {#each Object.entries($flags) as [key, value]}
          <div class="feature-flag-item">
            <span class="meta-info">{key}</span>
            <Switch
              color="orange"
              label={key}
              checked={value}
              innerText={value ? "on" : "off"}
              onclick={() => setFlag(key as unknown as FeatureFlag, !value)}
            />
          </div>
        {/each}
      {:else}
        <p class="meta-info">Currently there aren't any feature flags 🎉</p>
      {/if}
    </Drawer>
  {/if}
</RenderFor>

<style>
  .feature-flag-item {
    display: flex;
    align-items: center;
    justify-content: flex-end;

    gap: var(--gap-m);
  }
</style>
